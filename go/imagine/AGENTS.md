# Imagine Agent Handbook
This handbook distills the practical knowledge agentic contributors need to operate inside `github.com/tillkuhn/angkor/tools/imagine`.
Follow the sections sequentially when spinning up a new task, but feel free to jump to the area you need during focused work.

## Repository Snapshot
- Monorepo segment lives in `go/imagine`; entry point is `main.go` which wires config, AWS session, worker queue, and HTTP server.
- Business packages: `server` (REST + mux), `s3` (worker and S3 utilities), `image`, `audio`, `auth`, `types`, `utils`.
- Assets in `static/`, sample audio in `audio/`, helper binaries or coverage artifacts (`coverage.html`, `coverage.out`) are generated by `make test`.
- `Makefile` defines the blessed workflows; favor it over ad-hoc commands whenever possible.
- `README.adoc` documents env vars and examples; keep it in sync when adding operational flags.
- `sonar-project.properties` exists for static analysis; update if new top-level dirs are added.
- No vendor directory is committed; module resolution relies on `go.mod` + `go.sum`.
- Tests colocate with code (`*_test.go`). Integration-style samples exist under `server`, `auth`, `audio`, `s3`, and `utils`.

## Go Toolchain & Dependencies
- `go.mod` pins `go 1.23` with `toolchain go1.24.2`; install Go 1.24.2+ to avoid mismatched standard libraries.
- Primary deps: `aws-sdk-go`, `gorilla/mux`, `zerolog`, `envconfig`, `imaging`, `dhowden/tag`, `ttlcache`, `prometheus/client_golang`.
- Keep `go.sum` tidy; run `go mod tidy` after dependency edits and before committing.
- AWS SDK uses classic v1 client; ensure credentials exist via shared config or `AWS_PROFILE=timafe` as in `Makefile`.
- Optional utilities (`gotest`, `golangci-lint`, `goimports`) must be installed globally; scripts assume they are in `$PATH`.
- Images/audio rely on native CGO-free builds; maintain `CGO_ENABLED=0` for reproducible dist binaries.
- Zerolog is the uniform logging facade; avoid mixing with `log.Printf` except where legacy behavior exists.

## Environment & Secrets
- Runtime configuration is sourced from env vars prefixed with `IMAGINE_` per `types.Config` struct tags.
- Sensitive tokens live in `~/.angkor/.env`; `Makefile` extracts `IMAGINE_JWKS_ENDPOINT` and `APP_API_TOKEN_METRICS` from there.
- `make run` refuses to start if `AWS_SESSION_TOKEN` is already set; open a fresh shell if you need to assume a profile.
- Kafka creds default to sibling Kotlin project config; override via env if running outside the shared dev box.
- Local uploads land in `./upload`; ensure the folder exists and is writable before running ingestion tests.
- `BASE_URL` defaults to `http://localhost:8090`; override for staging/prod when exercising curl helpers.
- Never commit `.token`, AWS creds, or coverage artifacts; they are user-specific.
- When adding new env vars, document defaults in `types.Config` (`default`, `required`, `desc`) so `envconfig` usage/help stays accurate.

## Build & Run Commands
- `make help` lists all curated tasks; add `## description` comments for any new targets to keep the help text clean.
- `make format` (alias `make fmt`) runs `go fmt ./...` and `goimports -w .`; use before submitting patches.
- `make lint` formats first, then executes `golangci-lint run`; configure additional linters via `.golangci.yml` when introduced.
- `make build` compiles a static binary at `dist/imagine`; embeds `main.BuildTime` for traceability.
- `make build-linux` cross-compiles (`GOOS=linux GOARCH=amd64 CGO_ENABLED=0`) to `dist/linux/imagine`.
- `make run` performs health checks, injects default env vars, and starts `go run $(GO_FILES)`; ensure port 8090 is free.
- `go run main.go` works for quick smoke tests but skip the `Makefile` guardrails at your own risk.
- Curl helpers such as `make get-health`, `make get`, `make get-metrics`, `make post-song`, etc., encode both headers and sample payloads—use them as reproducible API fixtures.
- Clean artifacts with `make clean`; this removes `dist/` but leaves coverage files intact.
- Use `make outdated` to audit module freshness; it installs `go-mod-outdated` if missing.
- Dependency upgrades happen via `make update` (`go get -u`); rerun `go mod tidy` afterward.

## Testing Playbook
- `make test` is the canonical suite runner: it prefers `gotest -v -coverpkg=./... -coverprofile=coverage.out ./...` and falls back to `go test` if `gotest` is absent.
- Coverage summary prints via `go tool cover -func coverage.out | grep "total:"`; full HTML goes to `coverage.html`.
- Single-package test: `go test ./server -v` (replace `./server` with the target directory).
- Single-test filter: `go test ./server -run TestItShouldReUsePresignURL -count=1` (avoid caching with `-count=1`).
- Use `GOWORK=off` (if needed) when invoking `go test` to ensure module boundaries remain consistent with CI.
- For race detection, append `-race` to package-level commands; be mindful of CGO overhead.
- Snapshot tests rely on temporary files in `./upload`; cleanup occurs via helper functions—call `t.Cleanup` if you add new fixtures.
- HTTP handlers are tested with `httptest.NewRecorder`, `httptest.NewRequest`, and `mux.SetURLVars` (see `server/http_test.go`).
- Auth tests require env seeds like `IMAGINE_S3BUCKET` and `IMAGINE_ENABLE_AUTH`; set them inside the test function to avoid bleed-over.
- Worker tests (`s3/worker_test.go`) orchestrate fake `session.Session` objects; prefer interface seams if stubbing new AWS calls.
- Run `go tool cover -html=coverage.out` to visually confirm which branches remain untested when touching complex flows.
- Keep test output deterministic (sorted tag maps, predictable IDs) so `go test -run` comparisons remain stable.

## Linting & Formatting
- Always run `make format` before staging; it enforces `go fmt` and `goimports` (handles std/lib/third-party grouping).
- `golangci-lint run` is expected to pass cleanly; add linters via config rather than per-invocation flags.
- Favor `staticcheck`-compatible patterns: no unused params, avoid `fmt.Printf` in libraries unless behind `*_test.go` or explicitly intended.
- Imports follow Go conventions: stdlib, then blank line, then third-party, then project-local `github.com/tillkuhn/angkor/tools/imagine/...` groups.
- Use `go vet ./...` if you touch reflection, unsafe, or tricky concurrency; mention in PR notes when relevant.
- Restrict global state; if necessary, guard with `sync.Once` and document thread-safety.
- Keep files ASCII unless domain data requires Unicode (e.g., emoji logger already exists in `image/image.go`).
- Avoid rewriting generated data or vendored code—none exists yet, so keep it that way.

## Code Style – Imports & Modules
- Prefer fully qualified module paths inside repo packages; avoid relative imports.
- `log.Logger.With().Str("logger", "component").Logger()` establishes component-specific loggers—reuse that idiom for new packages.
- Alias collisions: rename imports only when clarity improves (e.g., `awsS3` is unnecessary; stick with `s3`).
- Keep import blocks deterministic; `goimports` will prune unused packages, so do not leave scaffolding with `_` imports.
- When adding third-party libs, justify them in PR description and ensure licensing is compatible.
- Avoid editing `go.mod` indirectly (e.g., `go get ./...`) unless adding/upgrading dependencies.
- Document any new CLI dependencies in `README.adoc` and this file so future agents can install prerequisites quickly.

## Code Style – Types & Structs
- DTOs live in `types/types.go`; use explicit JSON tags (`json:"fieldName"`) and omit-from-JSON tagging via `json:"-"`.
- Config fields in `types/config.go` must include `default`, `desc`, and `split_words` tags—`envconfig` surfaces these in `-h` output.
- Use Go's zero values for optional fields; avoid pointer booleans unless tri-state logic is required.
- Favor `map[string]string` for lightweight tag bags; document expected keys near creation sites.
- When returning custom structs, prefer value types unless large slices or maps must be shared; copy when exposing internal state.
- Keep exported names meaningful (`UploadRequest`, `ListResponse`); unexport helpers unless cross-package usage is planned.
- Ensure struct literals populate fields in declared order to reduce diff noise and aid readability.

## Code Style – Functions & Error Handling
- Return early on validation errors (see `server/http.go:123` `PostObject` guards); keep success path shallow.
- Wrap external errors with context using `fmt.Errorf("...: %w", err)` or zerolog's `.Err(err)` before returning HTTP 5xx responses.
- HTTP handlers set `Content-Type` and use `http.Error` for user-facing messages; log internal details separately if sensitive.
- Always `defer utils.CheckedClose(...)` immediately after opening files, HTTP bodies, or multipart readers.
- Use `time.Since(start)` for latency logging (e.g., `s3/uploadToS3`); prefer milliseconds for human readability.
- When mutating request-scoped structs, pass pointers; when broadcasting via channels, push value copies to avoid race conditions (`s3.Handler.UploadRequest`).
- Panics should be contained; recover at worker boundaries if you introduce goroutines beyond the existing cache cleanup.
- Validate external input (filenames, URLs) before using them in S3 keys; reuse `utils.StripRequestParams` and `sanitizeTagValue`.
- For sentinel errors (`authError`), keep them package-private and compare via `errors.Is` if exported future behavior requires it.

## HTTP & Routing Conventions
- Gorilla mux powers routing; set vars with `mux.Vars` and reuse helpers like `extractEntityVars` to avoid duplicate parsing logic.
- `server.Handler` centralizes S3 access, caching, and config; instantiate once and reuse across routes.
- All responses should set `ContentTypeJson`; call `enc.SetEscapeHTML(false)` when streaming JSON arrays containing HTML entities.
- Temporary redirects for presigned URLs use `http.StatusTemporaryRedirect`; include `Cache-Control` derived from `config.PresignExpiry`.
- `ListSongs` and `PostSong` simply override mux vars before delegating—follow that pattern for future specialized routes.
- When adding query params, extend `parseResizeParams`-style helpers to keep request parsing isolated.
- Health endpoints (`server.Health`) should remain side-effect free and return RFC3339 timestamps for uptime monitors.

## S3 Worker & Media Processing
- The worker queue is a buffered channel sized via `config.QueueSize`; pushing is non-blocking until capacity fills—monitor metrics if you adjust defaults.
- `putObject` performs content-type sniffing using the first 512 bytes and populates tag maps before uploading.
- EXIF extraction occurs for JPEG files only; PNG/WebP support would require extending `image.ExtractExif`.
- Audio uploads trigger `audio.ExtractTags`; keep tag keys Title/Artist/Genre/Album/Year/Track/Rating consistent for downstream consumers.
- Resized assets follow `originalKey -> resizeMode/originalFilename`; update `server.GetObjectPresignUrl` if you introduce new modes.
- Temporary files must be deleted after upload; call `os.Remove` on both originals and thumbnails, respecting error logs.
- Garbage collection can be forced (`config.ForceGc`) after heavy image work; log memory stats via `utils.MemStats` for traceability.
- Tag ordering is sorted alphabetically (`encodeTagMap`) to ensure deterministic strings; maintain this if adding metadata.

## Auth & Security
- Auth middleware (`auth/middleware.go`) supports static token checks and JWT validation via JWKS; enablement controlled by `Config.EnableAuth`.
- Headers: prefer `X-Authorization` but fall back to `Authorization` to support tools like Grafana.
- `auth.New` logs initialization state; ensure JWKS URL availability when enabling auth locally.
- JWT claims must expose either `scope` or `cognito:roles`; reject tokens lacking both to avoid privilege ambiguities.
- Store parsed claims in `context.Context` via `context.Set(req, ContextAuthKey, claims)`; downstream handlers should type-assert to `*auth.TokenInfo`.
- When adding protected routes, wrap them with `ValidationMiddleware`; never bypass it in production code.
- Error responses should avoid leaking secret material; log with zerolog but keep HTTP bodies concise.
- Metrics endpoint requires bearer token (`make get-metrics`); ensure new diagnostic routes enforce equivalent checks.

## Logging & Observability
- Zerolog is the default; create scoped loggers with `log.Logger.With().Str("logger", "component")` to filter by subsystem.
- Use `.Debug()` for verbose flow info, `.Info()` for lifecycle events, `.Warn()` when recovering, `.Error()` for actionable failures, `.Trace()` for GC-heavy traces.
- Health data exposes allocator stats using `utils.MemStats`; reuse this helper instead of duplicating runtime logic.
- Cache lifecycle events (TTL cache start/stop) should log via `log.Printf`; convert to structured logs if you expand instrumentation.
- Include request IDs in logs; `types.UploadRequest.RequestId` is generated with `xid.New()`—propagate when spawning goroutines.
- Prefer structured key/value logging (e.g., `.Str("key", value)`) rather than concatenated strings for future log shipping.
- When adding metrics, follow Prometheus conventions already used through `prometheus/client_golang`.

## Cursor / Copilot Instructions
- No `.cursor/rules/`, `.cursorrules`, or `.github/copilot-instructions.md` files exist in this repo as of this document; this handbook is the authoritative agent policy.
- If future automation rules are added, summarize them in this section and link to the canonical file path.

## Agent Workflow Checklist
- Sync repo, inspect `git status`, and scan this file before editing.
- Run `make format` + `make lint` locally; fix issues before staging.
- Execute targeted tests (`go test ./path -run TestName -count=1`) plus `make test` for wider regressions.
- Update docs (`README.adoc`, this file) whenever commands, env vars, or behaviors change.
- Avoid committing generated artifacts (`coverage.html`, `coverage.out`, `dist/`); clean them or add to `.gitignore` if needed.
- Reference this checklist in PR descriptions to show due diligence.
- When automation is unclear, leave breadcrumbs here so the next agent inherits context without spelunking.
