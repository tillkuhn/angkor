= NeonDB Database Module

== References

* https://neon.com/docs/reference/terraform[Tutorial]
* https://registry.terraform.io/providers/kislerdm/neon/latest/docs[Official Provider Documentation]


== Steps

* create project scoped api key in https://console.neon.tech/ (Settings -> API Keys)
* setup provider in versions.tf and api key in providers.tf

== Database Migration

See https://neon.com/docs/import/migrate-from-neon

.TL;DR
----
pg_dump -f db.dump -Fc -v -d postgresql://[old_owner]:[password]@[source_neon_hostname]/[dbname]
cat db_dump | pg_restore --no-owner --role=new_owner -v -d postgresql://[new_owner]:[password]@[destination_neon_hostname]/[dbname]
----

== Readonly Role e.g. for Grafana pg datasource

https://neon.com/docs/manage/database-access#create-a-read-only-role[]

----
CREATE ROLE readonly PASSWORD '<password>';


-- Grant permission to connect to the database
GRANT CONNECT ON DATABASE <database> TO readonly;
-- Grant USAGE on the schema
GRANT USAGE ON SCHEMA <schema> TO readonly;
-- Grant SELECT on all existing tables in the schema
GRANT SELECT ON ALL TABLES IN SCHEMA <schema> TO readonly;
-- Grant SELECT on all tables added in the future
ALTER DEFAULT PRIVILEGES IN SCHEMA <schema> GRANT SELECT ON TABLES TO readonly;

CREATE ROLE readonly_user1 WITH LOGIN PASSWORD '<password>';

GRANT readonly TO readonly_user1;
----

