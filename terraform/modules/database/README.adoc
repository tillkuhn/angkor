= NeonDB Database Module

== References

* https://neon.com/docs/reference/terraform[Tutorial]
* https://registry.terraform.io/providers/kislerdm/neon/latest/docs[Official Provider Documentation]


== Prerequisites

* Account on https://neon.com/ (free tier available, Oauth2 via Github, Google, etc.)
* Project created in https://console.neon.tech/[Neon Console] with default branch
* https://phase.dev/[phase.dev] account (free tier available, Oauth2 via Github, Google, etc.)
* Secrets `provided/NEON_PROJECT_ID` and `provided/NEON_API_KEY` in phase production environment are maintained

== Steps

* create project scoped api key in https://console.neon.tech/ (Settings -> API Keys)
* setup provider in versions.tf and api key in providers.tf

== Database Migration

See https://neon.com/docs/import/migrate-from-neon

.TL;DR
----
pg_dump -f db.dump -Fc -v -d postgresql://[old_owner]:[password]@[source_neon_hostname]/[dbname]
cat db_dump | pg_restore --no-owner --role=new_owner -v -d postgresql://[new_owner]:[password]@[destination_neon_hostname]/[dbname]
----

== Readonly Role e.g. for Grafana pg datasource

https://neon.com/docs/manage/database-access#create-a-read-only-role[]
but see also https://stackoverflow.com/a/78733307/4292075
'GRANT pg_read_all_data to username;' (requires admin permissions to grant)

----
CREATE ROLE readonly PASSWORD '<password>';

-- Grant permission to connect to the database
GRANT CONNECT ON DATABASE "angkor-prod" TO readonly;
-- Grant USAGE on the schema
GRANT USAGE ON SCHEMA public TO readonly;
-- Grant SELECT on all existing tables in the schema
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;
-- Grant SELECT on all tables added in the future
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO readonly;

CREATE ROLE grafana WITH LOGIN PASSWORD '<password>';

GRANT readonly TO grafana;
----

== Database Backup with r/o user

----
PGPASSWORD='<password>' pg_dump -f db-backup.dump -n public -Fc -v -U grafana  \
  -d 'postgresql://<host>.eu-central-1.aws.neon.tech/angkor-prod?sslmode=require'
----
